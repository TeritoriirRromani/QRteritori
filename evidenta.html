<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evidență teritorii</title>

  <!-- Stil comun pentru toate paginile -->
  <link rel="stylesheet" href="introducere-style.css">

  <!-- Chart.js pentru grafic (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .evidenta-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .evidenta-item {
      border: 2px solid #d4dff0;
      background: #f8fafd;
      border-radius: 16px;
      padding: 14px;
      text-align: left;
      animation: fadeIn 0.35s ease;
      transition: 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evidenta-row {
      display: grid;
      grid-template-columns: 1.4fr 1fr 1fr;
      gap: 10px;
      align-items: start;
    }

    .e-label {
      font-size: 12px;
      opacity: 0.75;
      margin-bottom: 4px;
    }

    .e-value {
      font-size: 14px;
      font-weight: 600;
      word-break: break-word;
    }

    .badge {
      margin-left: 6px;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }
    .badge-urgent { background:#ffd6d6; color:#d93025; }
    .badge-warning { background:#fff3cd; color:#f9a825; }
    .badge-ok { background:#e6f4ea; color:#1e8e3e; }

    .progress-container {
      margin-top: 10px;
      height: 6px;
      background: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar { height: 100%; transition: width 0.6s ease; }

    /* Dashboard */
    .dash-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 10px 0 12px 0;
    }

    .dash-card {
      border: 2px solid #d4dff0;
      background: #f8fafd;
      border-radius: 16px;
      padding: 12px;
      text-align: center;
    }
    .dash-num {
      font-size: 18px;
      font-weight: 800;
      margin-top: 2px;
    }
    .dash-num.urgent { color: #d93025; }
    .dash-num.warning { color: #f9a825; }
    .dash-num.ok { color: #1e8e3e; }

    /* Buton predă subtil */
    .btn-preda {
      margin-top: 10px;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      background: transparent;
      border: 1.5px solid #365f9c;
      color: #365f9c;
      transition: all 0.2s ease;
    }
    .btn-preda:hover { background: #365f9c; color: white; }

    .btn-preda.urgent {
      border-color: #d93025;
      color: #d93025;
    }
    .btn-preda.urgent:hover { background: #d93025; color: white; }

    .fade-out {
      opacity: 0;
      transform: translateY(-10px);
      transition: 0.3s ease;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: white;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 14px;
      opacity: 0;
      transition: 0.3s ease;
      z-index: 999;
    }
    .toast.show { opacity: 1; }

    /* grafic container */
    .chart-card canvas {
      margin-top: 10px;
    }

    @media (max-width: 700px) {
      .dash-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px) {
      .evidenta-row { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <!-- Badge sus -->
  <div class="page-info">
    <span id="info-teritorii">Teritorii active: 0</span>
  </div>

  <div class="form-container">
    <h1>Evidență teritorii</h1>

    <!-- DASHBOARD -->
    <div class="dash-grid">
      <div class="dash-card">
        <div class="e-label">Active</div>
        <div class="dash-num" id="d-active">-</div>
      </div>
    
      <div class="dash-card">
        <div class="e-label">Urgent (≤14)</div>
        <div class="dash-num urgent" id="d-urgent">-</div>
      </div>
    
      <div class="dash-card">
        <div class="e-label">Atenție (≤30)</div>
        <div class="dash-num warning" id="d-atentie">-</div>
      </div>
    
      <div class="dash-card">
        <div class="e-label">OK</div>
        <div class="dash-num ok" id="d-ok">-</div>
      </div>
    
      <div class="dash-card">
        <div class="e-label">Lucrate ultimul an</div>
        <div class="dash-num" id="d-an">-</div>
        <div style="font-size:12px;opacity:0.7;" id="d-an-p">-</div>
      </div>
    
      <div class="dash-card">
        <div class="e-label">Active acum</div>
        <div class="dash-num" id="d-active-perf">-</div>
        <div style="font-size:12px;opacity:0.7;" id="d-active-p">-</div>
      </div>
    </div>

    <!-- GRAFIC EVOLUȚIE -->
    <div class="evidenta-item chart-card">
      <div class="e-label">Evoluție (ultimele 30 zile)</div>
      <canvas id="chartEvo" height="120"></canvas>
    </div>

    <!-- LISTĂ -->
    <div class="evidenta-list" id="evidentaList">
      <div class="evidenta-item">Se încarcă…</div>
    </div>

    <button type="button" onclick="refreshAll()">Reîncarcă tot</button>
    <p id="status"></p>
  </div>

  <!-- Nav jos -->
  <nav class="bottom-nav">
    <a href="introducere.html">
      <img src="icon-introducere.svg" class="icon-img">
      <span class="label">Intro</span>
    </a>
    <a href="predare.html">
      <img src="icon-predare.svg" class="icon-img">
      <span class="label">Predă</span>
    </a>
    <a href="evidenta.html" class="active">
      <img src="icon-evidenta.svg" class="icon-img">
      <span class="label">Evidență</span>
    </a>
  </nav>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Script config -->
  <script src="config.js"></script>

  <script>
    // ===============================
    // Helpers
    // ===============================
    function esc(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function setStatus(text, type){
      const el = document.getElementById('status');
      el.textContent = text || '';
      el.className = type || '';
    }

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 3500);
    }

    function loadJsonp(url){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=url;
        s.onload=()=>{s.remove(); resolve();};
        s.onerror=()=>{s.remove(); reject(new Error('JSONP load failed'));};
        document.body.appendChild(s);
      });
    }

    function loadPerformance(){
  return loadJsonp(SCRIPT_URL + '?action=performance&callback=populatePerformance');
}

window.populatePerformance = function(d){
  document.getElementById('d-an').textContent = d.lucrateAn ?? 0;
  document.getElementById('d-an-p').textContent =
    (d.procentAn ?? 0) + '% din total (' + (d.total ?? 0) + ')';

  document.getElementById('d-active-perf').textContent = d.active ?? 0;
  document.getElementById('d-active-p').textContent =
    (d.procentActive ?? 0) + '% din total';
};


    // ===============================
    // Dashboard (JSONP)
    // ===============================
    function loadDashboard(){
      return loadJsonp(SCRIPT_URL + '?action=dashboard&callback=populateDashboard');
    }

    window.populateDashboard = function(d){
      document.getElementById('d-active').textContent = d?.active ?? 0;
      document.getElementById('d-urgent').textContent = d?.urgent ?? 0;
      document.getElementById('d-atentie').textContent = d?.atentie ?? 0;
      document.getElementById('d-ok').textContent = d?.ok ?? 0;
    };

    // ===============================
    // Evoluție (Chart.js) (JSONP)
    // ===============================
    let evoChart = null;

    function loadEvolutie(days = 30){
      return loadJsonp(SCRIPT_URL + `?action=evolutie&days=${days}&callback=populateEvolutie`);
    }

    window.populateEvolutie = function(rows){
      const arr = Array.isArray(rows) ? rows : [];

      const labels = arr.map(r => r.date);
      const active = arr.map(r => r.active);
      const urgent = arr.map(r => r.urgent);

      const ctx = document.getElementById('chartEvo').getContext('2d');

      if (evoChart) evoChart.destroy();

      evoChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Active', data: active, tension: 0.35 },
            { label: 'Urgente', data: urgent, tension: 0.35 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    };

    // ===============================
    // Evidență (JSONP)
    // ===============================
    function loadEvidenta(){
      const list = document.getElementById('evidentaList');
      list.innerHTML = `<div class="evidenta-item">Se încarcă…</div>`;
      return loadJsonp(SCRIPT_URL + '?action=evidenta&callback=populateEvidenta');
    }

    window.populateEvidenta = function(data){
      const list = document.getElementById('evidentaList');
      const info = document.getElementById('info-teritorii');

      let arr = Array.isArray(data) ? data : [];
      arr.sort((a,b) => (a.zileRamase ?? 0) - (b.zileRamase ?? 0));

      info.textContent = 'Teritorii active: ' + arr.length;

      if (!arr.length) {
        list.innerHTML = `<div class="evidenta-item">Nu există teritorii active.</div>`;
        return;
      }

      list.innerHTML = '';

      arr.forEach(row => {
        const teritoriu = String(row.teritoriu ?? '');
        const zile = Number(row.zileRamase) || 0;
        const luni = Math.floor(zile / 30);

        const total = 120; // perioada standard
        const procent = Math.min((zile / total) * 100, 100);

        let badgeClass="badge-ok", badgeText="OK";
        let barColor="#1e8e3e", textColor="#1e8e3e", btnClass="";

        if (zile <= 14){
          badgeClass="badge-urgent"; badgeText="URGENT";
          barColor="#d93025"; textColor="#d93025"; btnClass="urgent";
        } else if (zile <= 30){
          badgeClass="badge-warning"; badgeText="ATENȚIE";
          barColor="#f9a825"; textColor="#f9a825";
        }

        const card = document.createElement('div');
        card.className = 'evidenta-item';
        card.id = 'card-' + teritoriu;

        card.innerHTML = `
          <div class="evidenta-row">
            <div>
              <div class="e-label">Nume</div>
              <div class="e-value">
                ${esc(row.nume)}
                <span class="badge ${badgeClass}">${badgeText}</span>
              </div>
              <div class="e-label" style="margin-top:6px;">Data atribuirii</div>
              <div class="e-value" style="font-weight:600; opacity:0.9;">${esc(row.data)}</div>
            </div>

            <div>
              <div class="e-label">Teritoriu</div>
              <div class="e-value">${esc(teritoriu)}</div>
            </div>

            <div>
              <div class="e-label">Rămas</div>
              <div class="e-value" style="color:${textColor}; font-weight:800;">
                ${zile} zile (${luni} luni)
              </div>

              <div style="margin-top:10px;">
                <input type="date" id="date-${teritoriu}"
                       value="${new Date().toISOString().slice(0,10)}"
                       style="padding:4px;border-radius:6px;border:1px solid #ccc;font-size:12px;">
                <button class="btn-preda ${btnClass}" onclick="predaDirect('${teritoriu}')">
                  Predă
                </button>
              </div>
            </div>
          </div>

          <div class="progress-container">
            <div class="progress-bar" style="width:${procent}%; background:${barColor};"></div>
          </div>
        `;

        list.appendChild(card);
      });
    };

    // ===============================
    // Predare directă din evidență
    // ===============================
    async function predaDirect(teritoriu){
      try {
        const input = document.getElementById('date-' + teritoriu);
        const data = input?.value || new Date().toISOString().slice(0,10);

        const card = document.getElementById('card-' + teritoriu);
        if (card) card.classList.add('fade-out');

        const params = new URLSearchParams();
        params.append('action','preda');
        params.append('teritoriu', teritoriu);
        params.append('data', data);

        const resp = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const json = await resp.json();

        if (json.status === 'ok') {
          showToast('Teritoriu predat ✔');
          // refresh după o mică pauză (să se vadă animația)
          setTimeout(()=>refreshAll(), 450);
        } else {
          showToast('Eroare: ' + (json.mesaj || ''));
          if (card) card.classList.remove('fade-out');
        }
      } catch (err) {
        showToast('Eroare la predare');
        const card = document.getElementById('card-' + teritoriu);
        if (card) card.classList.remove('fade-out');
      }
    }

    // ===============================
    // Refresh complet (dashboard + grafic + listă)
    // ===============================
    async function refreshAll(){
      setStatus('', '');
      try {
        await loadDashboard();
        await loadPerformance();
        await loadEvolutie(30);
        await loadEvidenta();

      } catch (e) {
        setStatus('Eroare la încărcare: ' + e, 'error');
      }
    }

    window.addEventListener('load', refreshAll);
  </script>
</body>
</html>
